<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />

        <title>Static Navigation - SB Admin</title>
        <link href="../../css/layout.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
        <!-- Company chart handling is done inline in this file -->
        <!-- <script type="module" src="../../js/Company_chart.js"></script> -->
        <script type="module" src="../../js/R&D_Data.js"></script>

        <!-- 공통 기능 -->
        <script type="module" src="../../js/common.js"></script>

        <!-- 그래프-->
        <script type="module" src="../../js/weapon_system_pie.js"></script>
        <script type="module" src="../../js/weapon_import_pie.js"></script>
<script>
    const jsonFiles = {
        terrainData: '../../assets/data/나라별지형_with_coordinates.json',
    };
    // 페이지 로드 후 국가 데이터 로드는 나중에 통합된 DOMContentLoaded에서 실행

function visualizePieChart(labels, values) {
    const ctx = document.getElementById('pieChart').getContext('2d');

    if (window.pieChart) {
        window.pieChart.destroy(); // 기존 차트 제거
    }

    window.pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // 비율 유지 해제
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Weapon Systems Distribution' }
            }
        }
    });
}

async function loadCountryData(countrySelector, terrainTableContainer) {
    try {
        const response = await fetch('../../assets/data/나라별지형_with_coordinates.json');
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        const countryData = await response.json();

        if (!Array.isArray(countryData)) {
            throw new Error("Invalid JSON structure: expected an array.");
        }

        countrySelector.innerHTML = '<option value="" disabled selected>국가를 선택하세요</option>';
        countryData.forEach(country => {
            const option = document.createElement("option");
            option.value = country.Country;
            option.textContent = country.Country;
            countrySelector.appendChild(option);
        });

        countrySelector.addEventListener("change", () => {
            const selectedCountry = countrySelector.value;
            displayCountryTerrainTable(selectedCountry, countryData, terrainTableContainer);
            displayRNDData(selectedCountry); // R&D 데이터도 표시
            displayEconomicIndicators(selectedCountry); // 경제 지표 표시
        });
    } catch (error) {
        console.error("Error loading country data:", error);
        if (terrainTableContainer) {
            terrainTableContainer.innerHTML = `<div class="alert alert-danger">국가 데이터 로드 실패: ${error.message}</div>`;
        }
    }
}

function displayCountryTerrainTable(countryName, countryData) {
    const countryInfo = countryData.find((country) => country.Country === countryName);
    const terrainTableContainer = document.getElementById("countryTerrainTable");

    if (countryInfo) {
        terrainTableContainer.innerHTML = `
            <table class="table table-bordered">
                <thead>
                    <tr><th>항목</th><th>정보</th></tr>
                </thead>
                <tbody>
                    <tr><td>주요 항구/터미널</td><td>${countryInfo.major_ports_terminals || "데이터 없음"}</td></tr>
                    <tr><td>도로망(㎞)</td><td>${countryInfo.roadway_coverage_km || "데이터 없음"}</td></tr>
                    <tr><td>철도망(㎞)</td><td>${countryInfo.railway_coverage_km || "데이터 없음"}</td></tr>
                    <tr><td>운영 공항 수</td><td>${countryInfo.serviceable_airports || "데이터 없음"}</td></tr>
                    <tr><td>면적(㎢)</td><td>${countryInfo.square_land_area_km || "데이터 없음"}</td></tr>
                    <tr><td>해안선 길이(㎞)</td><td>${countryInfo.coastline_km || "데이터 없음"}</td></tr>
                    <tr><td>국경 길이(㎞)</td><td>${countryInfo.shared_borders_km || "데이터 없음"}</td></tr>
                    <tr><td>수로 길이(㎞)</td><td>${countryInfo.waterways_km || "데이터 없음"}</td></tr>
                </tbody>
            </table>
        `;
    } else {
        terrainTableContainer.innerHTML = `
            <div class="alert alert-danger" role="alert">
                해당 국가의 데이터를 찾을 수 없습니다.
            </div>
        `;
    }
}
</script>

<script>
    const RND_DATA_PATH = '../../assets/data/R&D_Data.json';
    let RND_Data = [];

    async function loadRNDData() {
        try {
            const response = await fetch(RND_DATA_PATH);
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            RND_Data = await response.json();
            console.log('R&D data loaded successfully:', RND_Data.length, 'records');
        } catch (error) {
            console.error("Error loading R&D Data:", error);
            // 오류가 발생해도 페이지는 계속 작동하도록 함
        }
    }

    function displayRNDData(countryName) {
        const rndDataTable = document.getElementById("rndDataTable");

        if (!RND_Data || RND_Data.length === 0) {
            rndDataTable.innerHTML = `
                <div class="alert alert-info">R&D 데이터를 로딩 중입니다...</div>
            `;
            return;
        }

        const countryRND = RND_Data.filter(data => data.Country === countryName);

        if (countryRND.length) {
            const tableRows = countryRND.map(data => `
                <tr class="project-name-row"><td><strong>프로젝트명</strong></td><td>${data.Project_Name || "데이터 없음"}</td></tr>
                <tr><td>프로그램명</td><td>${data.Program_Name || "데이터 없음"}</td></tr>
                <tr><td>목적</td><td>${data.Objective || "데이터 없음"}</td></tr>
                <tr><td>특징</td><td>${data.Features || "데이터 없음"}</td></tr>
                <tr><td colspan="2" style="height: 10px; background-color: #f0f0f0;"></td></tr>
            `).join("");

            rndDataTable.innerHTML = `
                <table class="table table-bordered">
                    <thead>
                        <tr><th style="width: 30%;">항목</th><th>상세 정보</th></tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        } else {
            rndDataTable.innerHTML = `
                <div class="alert alert-warning">${countryName}에 대한 R&D 데이터가 없습니다.</div>
            `;
        }
    }
</script>

<style>
    #countryTerrainTableContainer {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
    }
      /* Adjust overall layout styling */
      .table-responsive {
          margin-bottom: 20px;
      }
  
      #countryTerrainTable, #rndDataTable {
          max-height: 300px;
          overflow-y: auto;
      }
  
      canvas {
          margin-top: 20px;
      }
  
      h5 {
          margin-top: 20px;
      }

      .project-name-row {
        font-weight: bold; /* 행 전체를 굵게 표시 */
    }
    
    .info-box {
                position: fixed;
                top: 80px; /* Adjusted to clear the header */
                right: 20px;
                width: 300px;
                background-color: #ffffff;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                font-size: 0.9rem;
                overflow-y: auto; /* 내용이 넘치면 스크롤 생성 */
                transition: transform 0.3s, opacity 0.3s;
                opacity: 0.4; /* 기본 투명도 설정 */
            }

            .info-box h3 {
                font-size: 1.2rem;
                margin-bottom: 10px;
                color: #007bff;
                text-align: center;
            }

            .info-box ul {
                list-style-type: none;
                padding: 0;
                margin: 0;
            }

            .info-box li {
                margin-bottom: 10px;
                line-height: 1.5;
                color: #333;
            }

            .info-box strong {
                color: #007bff;
            }

            .toggle-button {
                width: 100%;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 8px;
                cursor: pointer;
                font-size: 1rem;
                transition: background-color 0.3s;
            }

            .toggle-button:hover {
                background-color: #0056b3;
            }

            .info-box.collapsed {
                opacity: 0.7;
                transform: scale(0.95);
            }

            .info-box.collapsed .toggle-button {
                background-color: #0056b3;
            }

            .hidden {
                display: none; /* Completely hide the content */
            }

            @media screen and (max-width: 768px) {
                .info-box {
                    width: 90%;
                    top: 70px; /* Adjust for mobile header spacing */
                    right: 5%;
                }
                .toggle-button {
                    font-size: 0.9rem;
                }
            }
                .info-box .info-content {
                display: block; /* 기본 표시 상태 */
            }

            .info-box .info-content.hidden {
                display: none; /* 숨김 상태 */
            }
            .info-box:hover {
            opacity: 1; /* 마우스를 올렸을 때 투명도 제거 */
        }
  </style>
    </head> 
    <body>
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <a class="navbar-brand ps-3" href="../../index.html">
                <img src="../../assets/images/logos/dmz-logo.png" alt="DMZ Logo"
                     style="max-width: 100px; height: auto; margin-right: 10px; display: block;">
            </a>
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            <!-- <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
                <div class="input-group">
                    <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." />
                    <button class="btn btn-primary" id="btnNavbarSearch"><i class="fas fa-search"></i></button>
                </div>
            </form> -->
            <!-- <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" data-bs-toggle="dropdown"><i class="fas fa-user fa-fw"></i></a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#!">Settings</a></li>
                        <li><a class="dropdown-item" href="#!">Activity Log</a></li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="#!">Logout</a></li>
                    </ul>
                </li>
            </ul> -->
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading"></div>
                            <a class="nav-link" href="analysis_1.html">국가별 데이터</a>
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseResearch" aria-expanded="false" aria-controls="collapseResearch">
                                기업별 데이터
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="collapseResearch" aria-labelledby="headingResearch" data-bs-parent="#sidenavAccordion">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="company/항공및우주기술.html"><i class="fas fa-plane"></i> &nbsp; 항공 및 우주기술</a>
                                    <a class="nav-link" href="company/해양방위및조선업.html"><i class="fas fa-ship"></i> &nbsp; 해양방위</a>
                                    <a class="nav-link" href="company/전자및시스템주요제품.html"><i class="fas fa-microchip"></i> &nbsp; 전자 및 시스템</a>
                                    <a class="nav-link" href="company/지상방위및무기시스템.html"><i class="fas fa-shield-alt"></i> &nbsp; 지상방위</a>
                                    <a class="nav-link" href="company/해외기업.html"><i class="fas fa-globe"></i> &nbsp; 해외기업</a>
                                </nav>
                            </div>
                            <a class="nav-link" href="analysis_3.html">비교 및 분석</a>
                        </div>
                    </div>
                    <div class="sb-sidenav-footer">
                        <div class="small">Producted by:</div>
                        천무 - ll
                    </div>
                </nav>
            </div>

            <div class="info-box" id="infoBox">
                <button class="toggle-button" onclick="toggleInfoBox()">컬럼 설명</button>
                <div class="info-content hidden"> <!-- hidden 클래스 추가 -->
                    <ul>
                        <li><strong>Category:</strong> 각 카테고리 숫자를 표시하며, 커서를 가져가면 세부 설명을 확인할 수 있습니다.</li>
                        <li><strong>Category1:</strong> 화기류, 근접공격무기류 및 전투용 산탄총류</li>
                        <li><strong>Category2:</strong> 총기류 및 화포류</li>
                        <li><strong>Category3:</strong> 탄약 및 관련 장비</li>
                        <li><strong>Category4:</strong> 이동발사체, 유도미사일, 탄도미사일, 로켓, 어뢰, 폭탄 및 지뢰</li>
                        <li><strong>Category5:</strong> 폭발물, 에너지물질, 추진제, 소이제 및 관련 구성품</li>
                        <li><strong>Category6:</strong> 전함 및 해군 특수장비</li>
                        <li><strong>Category7:</strong> 탱크 및 군용차량</li>
                        <li><strong>Category8:</strong> 항공기 및 관련 장비</li>
                        <li><strong>Category9:</strong> 군 훈련용 장비 및 훈련</li>
                        <li><strong>Category10:</strong> 개인방호장비 및 보호시설</li>
                        <li><strong>Category11:</strong> 군 전자장비</li>
                        <li><strong>Category12:</strong> 사격통제, 거리측정기, 광학기기 및 통제장비</li>
                        <li><strong>Category13:</strong> 보조군사장비</li>
                        <li><strong>Category14:</strong> 독극물</li>
                        <li><strong>Category15:</strong> 우주선 시스템 및 관련 장비</li>
                        <li><strong>Category16:</strong> 핵무기 관련 설계, 시험장비</li>
                        <li><strong>Category17:</strong> 기타 군용물자</li>
                        <li><strong>Category18:</strong> 지향성 에너지 무기체계</li>
                        <li><strong>Category19:</strong> 생물학적 또는 방사성 물질</li>
                        <li><strong>Category20:</strong> 잠수함, 해양 및 관련 장비</li>
                        <li><strong>Category21:</strong> 기타 군용물자</li>
                        <li><strong>Category22:</strong> 군사 인력</li>
                    </ul>
                </div>
            </div>
            
            
            <!-- 메인 콘텐츠 -->
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">비교 및 분석 대시보드</h1>
                        <p class="breadcrumb-item active">국가 및 기업 데이터를 선택하여 비교 분석하세요.</p>

                        <!-- 국가 비교 섹션 -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-globe"></i>
                                        국가 간 비교 분석
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label for="compareCountry1">국가 1</label>
                                                <select id="compareCountry1" class="form-select">
                                                    <option value="" selected disabled>국가를 선택하세요</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="compareCountry2">국가 2</label>
                                                <select id="compareCountry2" class="form-select">
                                                    <option value="" selected disabled>국가를 선택하세요</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="compareCountry3">국가 3 (선택)</label>
                                                <select id="compareCountry3" class="form-select">
                                                    <option value="" selected>선택하지 않음</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button onclick="compareCountries()" class="btn btn-primary mt-3">비교 시작</button>

                                        <!-- 비교 결과 차트 -->
                                        <div class="row mt-4">
                                            <div class="col-md-6">
                                                <h5>군사비 지출 비교</h5>
                                                <div style="height: 400px; position: relative;">
                                                    <canvas id="militaryExpenseComparisonChart"></canvas>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h5>무기 수출입 비교</h5>
                                                <div style="height: 400px; position: relative;">
                                                    <canvas id="armsTradeComparisonChart"></canvas>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 비교 데이터 테이블 -->
                                        <div class="mt-4">
                                            <h5>상세 비교 데이터</h5>
                                            <div id="comparisonTable" class="table-responsive"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 기존 콘텐츠를 두 개의 컬럼으로 분리 -->
                        <div class="row">
                            <!-- 국가 선택 섹션 -->
                            <div class="col-md-6 border-end">
                                <h5>- 국가 선택 -</h5>
                                <div class="mb-4">
                                    <select id="countrySelector" class="form-select">
                                        <option value="" selected disabled>국가를 선택하세요</option>
                                    </select>
                                </div>

                                <!-- 경고 메시지 -->
                                <div id="alertBox" style="display: none; background-color: red; color: white; padding: 10px; text-align: center; font-weight: bold;">
                                    해당 국가는 현재 전쟁 중이거나 UN 무기금수조치 국가입니다.
                                </div>
                                
                            <!-- 무기 시스템 파이 차트 -->
                                <div id="pieChartContainer" style="width: 530px; height: 530px; margin-bottom: 50px;">
                                    <canvas id="pieChart"></canvas>
                                </div>

                                <!-- 무기 수입 파이 차트 -->
                                <div id="weaponImportPieChartContainer" style="width: 530px; height: 530px; margin-bottom: 50px;">
                                    <canvas id="weaponImportPieChart"></canvas>
                                </div>

                                    <style>
                                    #pieChartContainer, #weaponImportPieChartContainer {
                                        position: relative; /* 차트 컨테이너 위치 설정 */
                                        margin: 0 auto; /* 차트 중앙 정렬 */
                                        margin-bottom: 50px; /* 두 차트 사이 여백 */
                                    }

                                    canvas {
                                        display: block;
                                        width: 100% !important;
                                        height: 100% !important;
                                    }

                                    </style>
                                
                                



                            </div>
        
                            <!-- 기업 및 데이터 표시 섹션 -->
                            <div class="col-md-6">
                                <!-- 지형 데이터 표시 -->
                                <div id="countryDataRow" class="row mt-4">
                                </div>

                                <!-- 경제 지표 카드 -->
                                <div id="economicIndicators" class="card mb-4" style="display: none;">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">경제 지표</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="economicIndicatorsContent"></div>
                                    </div>
                                </div>

                                <h5>국가별 지형 정보</h5>
                                <div id="countryTerrainTable" class="table-responsive"></div>
                                <h5>국가별 R&D 정보</h5>
                                <div id="rndDataTable" class="table-responsive"></div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                        </div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="../../js/analysis.js" defer></script>
        <script>
            function toggleInfoBox() {
                const infoBox = document.getElementById("infoBox");
                const infoContent = infoBox.querySelector(".info-content");

                // Toggle the 'hidden' class
                infoContent.classList.toggle("hidden");
            }

            // === 국가 경제 지표 표시 ===
            function displayEconomicIndicators(countryName) {
                const indicatorCard = document.getElementById('economicIndicators');
                const indicatorContent = document.getElementById('economicIndicatorsContent');

                if (!economyData || economyData.length === 0) {
                    indicatorCard.style.display = 'none';
                    return;
                }

                const countryEconomy = economyData.find(d => d.Country === countryName);

                if (countryEconomy) {
                    indicatorCard.style.display = 'block';
                    indicatorContent.innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">경제 지표</h6>
                                        <p class="card-text"><strong>${(countryEconomy['Economic Indicator'] / 1000000000).toFixed(2)}</strong> Billion USD</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">글로벌 순위</h6>
                                        <p class="card-text"><strong>#${countryEconomy['Rank']}</strong></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h6 class="card-title text-info">소득 가중치</h6>
                                        <p class="card-text"><strong>${countryEconomy['Income Weighted']?.toFixed(2) || 'N/A'}</strong></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h6 class="card-title text-warning">무역 수지</h6>
                                        <p class="card-text"><strong>${((countryEconomy['Trade Weighted'] || 0) / 1000000000).toFixed(2)}</strong> Billion USD</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    indicatorCard.style.display = 'none';
                }
            }

            // === 국가 비교 기능 ===
            let allCountriesData = {};
            let militaryData = [];
            let armsExportsData = [];
            let armsImportsData = [];
            let economyData = [];
            let governanceData = [];

            // 데이터 로드
            async function loadComparisonData() {
                try {
                    const [military, armsExport, armsImport, economy, governance, terrain] = await Promise.all([
                        fetch('../../assets/data/military_expenses_data.json').then(r => r.json()),
                        fetch('../../assets/data/arms_exports_data.json').then(r => r.json()),
                        fetch('../../assets/data/arms_import_data.json').then(r => r.json()),
                        fetch('../../assets/data/Economy_data.json').then(r => r.json()),
                        fetch('../../assets/data/governance_data.json').then(r => r.json()),
                        fetch('../../assets/data/나라별지형_with_coordinates.json').then(r => r.json())
                    ]);

                    militaryData = military;
                    armsExportsData = armsExport;
                    armsImportsData = armsImport;
                    economyData = economy;
                    governanceData = governance;

                    console.log('Data loaded:', {
                        military: militaryData.length,
                        armsExport: armsExportsData.length,
                        armsImport: armsImportsData.length,
                        economy: economyData.length,
                        governance: governanceData.length
                    });

                    // 비교 국가 선택 드롭다운 채우기 - 실제 국가만 필터링
                    const countrySet = new Set();

                    // Economy 데이터에서 실제 국가만 추출 (집계 데이터 제외)
                    economy.forEach(d => {
                        const country = d.Country;
                        // 지역 집계나 그룹 데이터 제외
                        if (country &&
                            !country.includes('income') &&
                            !country.includes('IDA') &&
                            !country.includes('IBRD') &&
                            !country.includes('states') &&
                            country !== 'World' &&
                            country !== 'OECD members' &&
                            !country.includes('dividend')) {
                            countrySet.add(country);
                        }
                    });

                    const countries = Array.from(countrySet).sort();

                    ['compareCountry1', 'compareCountry2', 'compareCountry3'].forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.innerHTML = id === 'compareCountry3' ?
                                '<option value="" selected>선택하지 않음</option>' :
                                '<option value="" selected disabled>국가를 선택하세요</option>';

                            countries.forEach(country => {
                                const option = document.createElement('option');
                                option.value = country;
                                option.textContent = country;
                                select.appendChild(option);
                            });
                        }
                    });

                    console.log('Comparison data loaded successfully:', countries.length, 'countries');
                } catch (error) {
                    console.error('Error loading comparison data:', error);
                    const comparisonTable = document.getElementById('comparisonTable');
                    if (comparisonTable) {
                        comparisonTable.innerHTML = `<div class="alert alert-danger">비교 데이터 로드 실패: ${error.message}</div>`;
                    }
                }
            }

            let militaryComparisonChart = null;
            let armsTradeComparisonChart = null;

            async function compareCountries() {
                const country1 = document.getElementById('compareCountry1').value;
                const country2 = document.getElementById('compareCountry2').value;
                const country3 = document.getElementById('compareCountry3').value;

                if (!country1 || !country2) {
                    alert('최소 2개 국가를 선택하세요.');
                    return;
                }

                const countries = [country1, country2];
                if (country3) countries.push(country3);

                console.log('Comparing countries:', countries);

                // 군사비 비교 차트 - Use GDP Military Weighted from Economy data as bar chart
                const militaryChartData = {
                    labels: countries,
                    datasets: [{
                        label: '군사비 지출 (Billion USD)',
                        data: countries.map(country => {
                            const econData = economyData.find(d => d.Country === country);
                            const militaryValue = econData && econData['GDP Military Weighted'] ?
                                econData['GDP Military Weighted'] : 0;
                            console.log(`${country} military spending:`, militaryValue, 'billion USD');
                            return militaryValue;
                        }),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                        borderColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                        borderWidth: 1
                    }]
                };

                const militaryCtx = document.getElementById('militaryExpenseComparisonChart').getContext('2d');
                if (militaryComparisonChart) militaryComparisonChart.destroy();

                militaryComparisonChart = new Chart(militaryCtx, {
                    type: 'bar',
                    data: militaryChartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: '군사비 지출 비교 (Billion USD)',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { font: { size: 11 } },
                                title: {
                                    display: true,
                                    text: 'Billion USD'
                                }
                            },
                            x: {
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });

                // 무기 수출입 비교 차트 (use 2020 as latest available year)
                const armsTradeData = {
                    labels: countries,
                    datasets: [
                        {
                            label: '무기 수출 (2020)',
                            data: countries.map(country => {
                                const exports = armsExportsData.find(d => d.Country === country);
                                if (exports && exports['2020']) {
                                    return exports['2020'] / 1000000; // Convert to millions
                                }
                                return 0;
                            }),
                            backgroundColor: '#4BC0C0'
                        },
                        {
                            label: '무기 수입 (2020)',
                            data: countries.map(country => {
                                const imports = armsImportsData.find(d => d.Country === country);
                                if (imports && imports['2020']) {
                                    return imports['2020'] / 1000000; // Convert to millions
                                }
                                return 0;
                            }),
                            backgroundColor: '#FF9F40'
                        }
                    ]
                };

                const armsCtx = document.getElementById('armsTradeComparisonChart').getContext('2d');
                if (armsTradeComparisonChart) armsTradeComparisonChart.destroy();

                armsTradeComparisonChart = new Chart(armsCtx, {
                    type: 'bar',
                    data: armsTradeData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { font: { size: 12 } }
                            },
                            title: {
                                display: true,
                                text: '무기 수출입 비교 (Million USD)',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });

                // 비교 테이블 생성
                displayComparisonTable(countries);
            }

            function displayComparisonTable(countries) {
                const tableContainer = document.getElementById('comparisonTable');

                const tableData = countries.map(country => {
                    // Economy data
                    const economy = economyData.find(d => d.Country === country);

                    // Military spending from GDP Military Weighted (already in billions)
                    const militaryValue = economy && economy['GDP Military Weighted'] ?
                        economy['GDP Military Weighted'].toFixed(2) : 'N/A';

                    // GDP from Economic Indicator
                    const gdpValue = economy ? ((economy['Economic Indicator'] || 0) / 1000000000).toFixed(2) : 'N/A';

                    // Governance data - use latest year's estimate
                    const countryGovernance = governanceData.filter(d => d.Country === country);
                    let govScore = 'N/A';
                    if (countryGovernance.length > 0) {
                        // Get most recent year's data
                        const latestData = countryGovernance.reduce((latest, current) =>
                            current.year > latest.year ? current : latest
                        );
                        govScore = latestData.estimate ? latestData.estimate.toFixed(2) : 'N/A';
                    }

                    // Arms export data (use 2020 as latest available year)
                    const armsExport = armsExportsData.find(d => d.Country === country);
                    const exportValue = armsExport && armsExport['2020'] ?
                        (armsExport['2020'] / 1000000).toFixed(2) : 'N/A';

                    // Arms import data (use 2020 as latest available year)
                    const armsImport = armsImportsData.find(d => d.Country === country);
                    const importValue = armsImport && armsImport['2020'] ?
                        (armsImport['2020'] / 1000000).toFixed(2) : 'N/A';

                    return {
                        country,
                        militaryExpense: militaryValue,
                        gdp: gdpValue,
                        governanceScore: govScore,
                        armsExport: exportValue,
                        armsImport: importValue
                    };
                });

                const tableHTML = `
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>국가</th>
                                <th>군사비 (Billion USD)</th>
                                <th>GDP (Billion USD)</th>
                                <th>거버넌스 점수</th>
                                <th>무기 수출 (Million USD, 2020)</th>
                                <th>무기 수입 (Million USD, 2020)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableData.map(data => `
                                <tr>
                                    <td><strong>${data.country}</strong></td>
                                    <td>${data.militaryExpense}</td>
                                    <td>${data.gdp}</td>
                                    <td>${data.governanceScore}</td>
                                    <td>${data.armsExport}</td>
                                    <td>${data.armsImport}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                tableContainer.innerHTML = tableHTML;
            }

            // === 통합 페이지 초기화 ===
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('Page initialization started...');

                try {
                    // 1. 국가 비교 데이터 로드
                    await loadComparisonData();

                    // 2. R&D 데이터 로드
                    await loadRNDData();

                    // 3. 국가 선택 드롭다운 초기화
                    const countrySelector = document.getElementById("countrySelector");
                    const terrainTableContainer = document.getElementById("countryTerrainTable");

                    if (countrySelector && terrainTableContainer) {
                        await loadCountryData(countrySelector, terrainTableContainer);
                    } else {
                        console.error("countrySelector 또는 terrainTableContainer를 찾을 수 없습니다.");
                    }

                    console.log('Page initialization completed!');
                } catch (error) {
                    console.error('Page initialization error:', error);
                }
            });
        </script>
    </body>
</html>
